<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kartei‑Karten Generator</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Lora:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
      .layout { display: grid; grid-template-columns: 1fr 380px; gap: 12px; padding: 12px; height: calc(100% - 58px); }
      .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 10px; padding: 12px; overflow-y: auto; overflow-x: hidden; }
      /* Toolbar becomes sticky for long tables */
      .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; position: sticky; top: 0; z-index: 5; background: var(--panel); padding-top: 4px; padding-bottom: 8px; }
      .btn-group { display: flex; gap: 6px; align-items: center; }
      .icon-btn { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 8px; background: #0f172a; border: 1px solid #2b3546; color: var(--text); cursor: pointer; box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset, 0 1px 2px rgba(0,0,0,.25); }
      .icon-btn:hover { background: #162036; border-color: #3a465b; }
      .icon-btn:active { transform: translateY(1px); }
      .icon-btn svg { width: 18px; height: 18px; fill: currentColor; }
      .icon-btn.danger { color: #ef4444; border-color: #51252a; }
      .icon-btn.danger:hover { background: #2a1417; }
      .grid { width: 100%; border-collapse: collapse; }
      .grid th, .grid td { border: 1px solid #374151; padding: 6px 8px; }
      /* Sticky table header for better orientation */
      .grid thead th { position: sticky; top: 0; background: #0b1220; box-shadow: 0 1px 0 #1f2937; z-index: 2; }
      /* Subtle zebra, hover and selection states */
      .grid tbody tr:nth-child(even) td { background: rgba(148,163,184,0.05); }
      .grid tbody tr:hover td { background: rgba(148,163,184,0.08); }
      .grid tbody tr.selected td { background: rgba(37,99,235,0.12); }
      .grid input { width: 100%; border: none; outline: none; background: transparent; color: var(--text); }
      .muted { color: var(--muted); font-size: 13px; }
      .card-preview { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .card { background: #0b1220; border: 1px solid #1f2937; border-radius: 10px; padding: 16px; min-height: 180px; display: grid; place-items: center; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.25) inset; }
      .row { display: flex; gap: 8px; align-items: center; }
      .field { display: grid; gap: 6px; margin-bottom: 8px; }
      select, input[type="number"], input[type="text"] { background: #0b1220; color: var(--text); border: 1px solid #374151; border-radius: 6px; padding: 6px 8px; }
      .empty { display: grid; place-items: center; min-height: 120px; color: var(--muted); border: 1px dashed #334155; border-radius: 8px; }
      /* Inspector with tabs */
      .inspector { display: grid; grid-template-rows: auto 1fr; height: 100%; }
      .inspector-header { position: sticky; top: 0; z-index: 3; background: var(--panel); padding-bottom: 8px; margin-bottom: 8px; }
      .tabs { display: flex; gap: 6px; background: #0b1220; padding: 4px; border-radius: 8px; border: 1px solid #1f2937; }
      .tab { flex: 1; padding: 6px 10px; background: #0f172a; border: 1px solid #1f2937; border-radius: 6px; color: var(--text); cursor: pointer; }
      .tab.active { background: #1f2937; border-color: #2b3546; }
      .inspector-body { overflow-y: auto; overflow-x: hidden; display: grid; gap: 12px; }
      [role="tabpanel"] { display: none; }
      [role="tabpanel"].active { display: block; }
      .inspector-footer { position: sticky; bottom: 0; padding: 8px; display: flex; justify-content: space-between; align-items: center; gap: 8px; background: linear-gradient(180deg, rgba(17,24,39,0.6), var(--panel)); border-top: 1px solid #1f2937; }
      @media (max-width: 980px) {
        .layout { grid-template-columns: 1fr; height: auto; }
      }
      @media (max-width: 720px) {
        .row { flex-wrap: wrap; }
      }
    </style>
    <!-- libs via CDN for MVP: PapaParse, SheetJS, jsPDF, html2canvas, JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  </head>
  <body>
    <header class="app-header">
      <h1>Kartei‑Karten Generator</h1>
      <nav>
        <a href="/" class="btn">Hub</a>
      </nav>
    </header>

    <main class="layout">
      <section class="panel">
        <div class="toolbar">
          <div class="btn-group">
            <label class="icon-btn" style="position: relative; overflow: hidden;" title="Datei laden">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 16l-4-4h3V4h2v8h3l-4 4zm-7 3h14a2 2 0 002-2V9a2 2 0 00-2-2h-4l-2-2H7L5 7H3a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              <input id="fileInput" type="file" accept=".csv,.xlsx,.xls,.ods" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
            </label>
            <button id="addRow" class="icon-btn" title="Zeile hinzufügen">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </button>
            <button id="duplicateRows" class="icon-btn" title="Ausgewählte duplizieren">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 8h10v10H8z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M6 6h10v10" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button id="deleteRows" class="icon-btn danger" title="Ausgewählte löschen">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12m-9 3v7m6-7v7M9 7l1-2h4l1 2m-9 0v12a2 2 0 002 2h8a2 2 0 002-2V7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </div>

          <label class="row muted"><input id="hasHeader" type="checkbox" /> Erste Zeile ist Header</label>
          <span id="rowCount" class="muted">0 Zeilen</span>
          <span id="validation" class="muted" aria-live="polite"></span>

          <div class="btn-group" style="margin-left:auto;">
            <button id="undo" class="icon-btn" title="Rückgängig">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10H3V6m0 4a8 8 0 118 8h-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button id="redo" class="icon-btn" title="Wiederholen">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 10h4V6m0 4a8 8 0 10-8 8h3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button id="openExportTab" class="btn primary" title="Zum Export">Exportieren</button>
          </div>
        </div>

        <table class="grid" id="dataGrid" aria-label="Tabellenansicht">
          <thead>
            <tr>
              <th style="width:36px;"><input type="checkbox" id="selectAll" title="Alle auswählen" /></th>
              <th style="width:30px;">↕︎</th>
              <th>A (Vorderseite)</th>
              <th>B (Rückseite)</th>
            </tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </section>

      <aside class="panel">
        <div class="inspector" id="inspector">
          <div class="inspector-header">
            <div class="tabs" role="tablist" aria-label="Einstellungen">
              <button class="tab active" id="tabKarte" data-tab="karte" role="tab" aria-selected="true" aria-controls="panelKarte">Karte</button>
              <button class="tab" id="tabExport" data-tab="export" role="tab" aria-selected="false" aria-controls="panelExport">Export</button>
              <button class="tab" id="tabPreview" data-tab="preview" role="tab" aria-selected="false" aria-controls="panelPreview">Vorschau</button>
            </div>
          </div>
          <div class="inspector-body">
            <section id="panelKarte" role="tabpanel" class="active">
              <div class="field">
                <label>Spaltenzuordnung</label>
                <div class="row">
                  <span class="muted">Vorderseite:</span>
                  <select id="colA"></select>
                  <span class="muted">Rückseite:</span>
                  <select id="colB"></select>
                </div>
              </div>

              <div class="field">
                <label>Darstellung</label>
                <div class="row">
                  <button id="alignToggle" class="btn" title="Textausrichtung umschalten">⟺</button>
                  <label class="muted">Schriftgröße (px) <input id="fontPx" type="number" value="28" step="1" min="10" max="72" /></label>
                </div>
                <div class="row">
                  <label class="muted">Hintergrundfarbe <input id="bgColor" type="color" value="#ffffff" /></label>
                  <label class="muted" title="Rahmen anzeigen">Rahmen <input id="borderEnabled" type="checkbox" checked /></label>
                  <label class="muted" title="Rahmenfarbe">Farbe <input id="borderColor" type="color" value="#334155" /></label>
                </div>
              </div>

              <div class="field">
                <label>Hintergründe</label>
                <div class="row">
                  <label class="btn" style="position: relative; overflow: hidden;" title="Vorderseite Bild">
                    🖼️ Front
                    <input id="bgFront" type="file" accept="image/*" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
                  </label>
                  <button id="bgFrontClear" class="btn" title="Front entfernen">✖</button>
                </div>
                <div class="row">
                  <label class="btn" style="position: relative; overflow: hidden;" title="Rückseite Bild">
                    🖼️ Back
                    <input id="bgBack" type="file" accept="image/*" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
                  </label>
                  <button id="bgBackClear" class="btn" title="Back entfernen">✖</button>
                </div>
                <div class="row">
                  <span class="muted">Bildanpassung:</span>
                  <select id="bgMode">
                    <option value="cover" selected>Füllen (cover)</option>
                    <option value="contain">Einpassen (contain)</option>
                  </select>
                </div>
              </div>
            </section>

            <section id="panelExport" role="tabpanel">
              <div class="field">
                <label>Export</label>
                <div class="row">
                  <label class="muted">Format
                    <select id="exportFormat">
                      <option value="pdf" selected>PDF</option>
                      <option value="png">PNG</option>
                      <option value="jpg">JPG</option>
                    </select>
                  </label>
                  <label class="muted">Inhalt
                    <select id="exportSide">
                      <option value="front">Front</option>
                      <option value="back">Back</option>
                      <option value="both" selected>Front+Back</option>
                    </select>
                  </label>
                </div>
                <div class="row">
                  <label class="muted">Pro Seite
                    <select id="cardsPerPage">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="4" selected>4</option>
                      <option value="6">6</option>
                      <option value="8">8</option>
                    </select>
                  </label>
                  <label class="muted">Papier
                    <select id="paperSize">
                      <option value="A4" selected>A4</option>
                      <option value="A6">A6</option>
                    </select>
                  </label>
                </div>
                <div class="row">
                  <label class="muted">Duplex Flip
                    <select id="flipEdge">
                      <option value="long" selected>Lange Kante</option>
                      <option value="short">Kurze Kante</option>
                    </select>
                  </label>
                  <label class="muted">Rückseitenrotation
                    <select id="backRotation">
                      <option value="auto" selected>Auto</option>
                      <option value="0">0°</option>
                      <option value="180">180°</option>
                    </select>
                  </label>
                </div>
                <div class="row">
                  <label class="muted">Seitenrand (mm)
                    <input id="pageMarginMm" type="number" value="12" step="1" min="0" max="30" />
                  </label>
                  <label class="muted">Gutter (mm)
                    <input id="gapMm" type="number" value="6" step="1" min="0" max="30" />
                  </label>
                </div>
                <div class="row">
                  <label class="muted">Back Offset X (mm)
                    <input id="backOffsetXMm" type="number" value="0" step="0.5" min="-5" max="5" />
                  </label>
                  <label class="muted">Back Offset Y (mm)
                    <input id="backOffsetYMm" type="number" value="0" step="0.5" min="-5" max="5" />
                  </label>
                </div>
                <div class="row">
                  <label class="muted" title="Schnittmarken anzeigen">Schnittmarken
                    <input id="showMarks" type="checkbox" checked />
                  </label>
                  <label class="muted" title="Nur für PNG/JPG relevant">Bildmodus
                    <select id="imageExportMode">
                      <option value="pages" selected>Seiten (Front/Back)</option>
                      <option value="cards">Einzelkarten</option>
                    </select>
                  </label>
                </div>
              </div>

              <div class="field">
                <label>Dateinamensvorlage</label>
                <input id="filenameTpl" type="text" value="karte_{index}_{front}" placeholder="z.B. karte_{index}_{front}" />
                <div class="muted">Platzhalter: {index}, {front}, {back}</div>
              </div>

              <div class="inspector-footer">
                <div id="exportSummary" class="muted">–</div>
                <button id="downloadBtn" class="btn primary">Exportieren</button>
              </div>
            </section>

            <section id="panelPreview" role="tabpanel">
              <div class="field">
                <label>Live‑Vorschau (erste ausgewählte Zeile)</label>
                <div class="card-preview">
                  <div class="card" id="previewFront" aria-label="Vorderseite" title="Vorderseite Vorschau" style="position:relative;"></div>
                  <div class="card" id="previewBack" aria-label="Rückseite" title="Rückseite Vorschau" style="position:relative;"></div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </aside>
    </main>

    <template id="cardTemplate">
      <div class="card" data-card>
        <div class="front" data-front></div>
        <div class="back" data-back style="display:none;"></div>
      </div>
    </template>

    <script src="/static/flashcards.js"></script>
  </body>
</html>

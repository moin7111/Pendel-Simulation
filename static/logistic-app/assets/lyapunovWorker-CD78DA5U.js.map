{"version":3,"file":"lyapunovWorker-CD78DA5U.js","sources":["../src/workers/lyapunovWorker.ts"],"sourcesContent":["/// <reference lib=\"webworker\" />\n\nimport type {\n  LogisticParams,\n  MainToWorker,\n  WorkerChunkPoint,\n  WorkerMsg,\n} from '../types/worker'\n\ndeclare const self: DedicatedWorkerGlobalScope\n\ntype LinearFitResult = {\n  slope: number\n  intercept: number\n  rSquared: number\n}\n\nlet isRunning = false\nlet isPaused = false\nlet shouldAbort = false\nconst resumeResolvers: Array<() => void> = []\n\nconst waitWhilePaused = () => {\n  if (!isPaused) return Promise.resolve()\n  return new Promise<void>((resolve) => {\n    resumeResolvers.push(resolve)\n  })\n}\n\nconst setPaused = (value: boolean) => {\n  isPaused = value\n  if (!isPaused) {\n    while (resumeResolvers.length) {\n      const resolveNext = resumeResolvers.pop()\n      resolveNext?.()\n    }\n  }\n}\n\nconst resetControlFlags = () => {\n  isRunning = false\n  setPaused(false)\n  shouldAbort = false\n}\n\nconst sendMessage = (msg: WorkerMsg) => {\n  self.postMessage(msg)\n}\n\nconst clampUnit = (value: number) => {\n  if (!Number.isFinite(value) || Number.isNaN(value)) {\n    return 1e-12\n  }\n  if (value <= 0) return 1e-12\n  if (value >= 1) return 1 - 1e-12\n  return value\n}\n\nconst logisticStep = (x: number, r: number) => {\n  const next = r * x * (1 - x)\n  return clampUnit(next)\n}\n\nconst tinyDelay = () => new Promise<void>((resolve) => setTimeout(resolve, 0))\n\nconst linearFit = (xs: number[], ys: number[]): LinearFitResult | null => {\n  if (xs.length < 2 || ys.length < 2 || xs.length !== ys.length) return null\n  const n = xs.length\n  let sumX = 0\n  let sumY = 0\n  let sumXX = 0\n  let sumXY = 0\n\n  for (let i = 0; i < n; i += 1) {\n    const x = xs[i]\n    const y = ys[i]\n    sumX += x\n    sumY += y\n    sumXX += x * x\n    sumXY += x * y\n  }\n\n  const denom = n * sumXX - sumX * sumX\n  if (Math.abs(denom) < 1e-12) return null\n\n  const slope = (n * sumXY - sumX * sumY) / denom\n  const intercept = (sumY - slope * sumX) / n\n\n  let ssRes = 0\n  let ssTot = 0\n  const meanY = sumY / n\n  for (let i = 0; i < n; i += 1) {\n    const x = xs[i]\n    const y = ys[i]\n    const yHat = slope * x + intercept\n    ssRes += (y - yHat) ** 2\n    ssTot += (y - meanY) ** 2\n  }\n\n  const rSquared = ssTot === 0 ? 1 : 1 - ssRes / ssTot\n  return { slope, intercept, rSquared }\n}\n\nconst computeLogisticLyapunov = async (params: LogisticParams) => {\n  const {\n    r,\n    x0,\n    delta0,\n    totalIters,\n    transient,\n    renormSteps,\n    chunkSize,\n    sampleEvery,\n  } = params\n\n  const totalSteps = transient + totalIters\n  const sampleStride = Math.max(1, sampleEvery)\n  const chunk: WorkerChunkPoint[] = []\n  const times: number[] = []\n  const distances: number[] = []\n  const logDistances: number[] = []\n  const runningLambdaSeries: number[] = []\n\n  let base = clampUnit(x0)\n  let perturbed = clampUnit(x0 + delta0)\n\n  let renormCounter = 0\n  const renormInterval = Math.max(1, renormSteps)\n  let renormEvents = 0\n  let sumLnRatio = 0\n  let lastLambda = Number.NaN\n\n  for (let iter = 0; iter < totalSteps; iter += 1) {\n    if (shouldAbort) {\n      sendMessage({ type: 'error', message: 'Berechnung abgebrochen.' })\n      return\n    }\n\n    // eslint-disable-next-line no-await-in-loop\n    await waitWhilePaused()\n\n    base = logisticStep(base, r)\n    perturbed = logisticStep(perturbed, r)\n\n    if (!Number.isFinite(base) || !Number.isFinite(perturbed)) {\n      sendMessage({ type: 'error', message: 'Numerischer Überlauf in der Simulation.' })\n      return\n    }\n\n    const diff = perturbed - base\n    let distance = Math.abs(diff)\n    if (!Number.isFinite(distance) || distance < 1e-18) {\n      distance = 1e-18\n    }\n\n    const divergence = distance\n\n    const t = iter - transient\n    const afterTransient = iter >= transient\n    const shouldRecord = afterTransient && ((iter - transient) % sampleStride === 0)\n\n    if (afterTransient) {\n      renormCounter += 1\n      if (renormCounter >= renormInterval) {\n        renormCounter = 0\n        const lnRatio = Math.log(distance / delta0)\n        if (Number.isFinite(lnRatio)) {\n          sumLnRatio += lnRatio\n          renormEvents += 1\n          lastLambda = sumLnRatio / (renormEvents * renormInterval)\n        }\n        const direction = diff >= 0 ? 1 : -1\n        perturbed = clampUnit(base + direction * delta0)\n      }\n    } else {\n      renormCounter += 1\n      if (renormCounter >= renormInterval) {\n        renormCounter = 0\n        const direction = diff >= 0 ? 1 : -1\n        perturbed = clampUnit(base + direction * delta0)\n      }\n    }\n\n    if (afterTransient && shouldRecord) {\n      const lnDistance = Math.log(divergence)\n      const point: WorkerChunkPoint = { t, d: divergence, ln_d: lnDistance }\n      if (Number.isFinite(lastLambda)) {\n        point.lambda_running = lastLambda\n      }\n      chunk.push(point)\n      times.push(t)\n      distances.push(distance)\n      logDistances.push(lnDistance)\n      runningLambdaSeries.push(Number.isFinite(lastLambda) ? lastLambda : Number.NaN)\n    }\n\n    if (chunk.length >= chunkSize) {\n      sendMessage({ type: 'chunk', points: [...chunk] })\n      chunk.length = 0\n    }\n\n    if ((iter + 1) % chunkSize === 0 || iter === totalSteps - 1) {\n      sendMessage({ type: 'progress', done: iter + 1, total: totalSteps })\n    }\n\n    if ((iter & 0xff) === 0) {\n      // eslint-disable-next-line no-await-in-loop\n      await tinyDelay()\n    }\n  }\n\n  if (chunk.length) {\n    sendMessage({ type: 'chunk', points: [...chunk] })\n  }\n\n  const lambda = renormEvents > 0 ? sumLnRatio / (renormEvents * renormInterval) : Number.NaN\n  const fit = linearFit(times, logDistances)\n  if (fit) {\n    sendMessage({\n      type: 'fit',\n      slope: fit.slope,\n      intercept: fit.intercept,\n      window: [times[0] ?? 0, times[times.length - 1] ?? 0],\n      rSquared: fit.rSquared,\n    })\n  }\n\n  sendMessage({\n    type: 'result',\n    lambda,\n    times,\n    d: distances,\n    ln_d: logDistances,\n    running_lambda: runningLambdaSeries.length ? runningLambdaSeries : undefined,\n  })\n}\n\nconst run = async (params: LogisticParams) => {\n  isRunning = true\n  shouldAbort = false\n  setPaused(false)\n  try {\n    await computeLogisticLyapunov(params)\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Unbekannter Worker-Fehler.'\n    sendMessage({ type: 'error', message })\n  } finally {\n    resetControlFlags()\n  }\n}\n\nself.addEventListener('message', (event: MessageEvent<MainToWorker>) => {\n  const msg = event.data\n  if (!msg) return\n  switch (msg.cmd) {\n    case 'start':\n      if (isRunning) {\n        sendMessage({ type: 'error', message: 'Es läuft bereits eine Berechnung.' })\n        return\n      }\n      run(msg.params)\n      break\n    case 'pause':\n      if (isRunning) {\n        setPaused(true)\n      }\n      break\n    case 'resume':\n      if (isRunning) {\n        setPaused(false)\n      }\n      break\n    case 'abort':\n      if (isRunning) {\n        shouldAbort = true\n        setPaused(false)\n      }\n      break\n    default:\n      break\n  }\n})\n"],"names":["isRunning","isPaused","shouldAbort","resumeResolvers","waitWhilePaused","resolve","setPaused","value","resetControlFlags","sendMessage","msg","clampUnit","logisticStep","x","r","next","tinyDelay","linearFit","xs","ys","n","sumX","sumY","sumXX","sumXY","i","y","denom","slope","intercept","ssRes","ssTot","meanY","yHat","rSquared","computeLogisticLyapunov","params","x0","delta0","totalIters","transient","renormSteps","chunkSize","sampleEvery","totalSteps","sampleStride","chunk","times","distances","logDistances","runningLambdaSeries","base","perturbed","renormCounter","renormInterval","renormEvents","sumLnRatio","lastLambda","iter","diff","distance","divergence","t","afterTransient","shouldRecord","lnRatio","direction","lnDistance","point","lambda","fit","run","error","message","event"],"mappings":"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"}